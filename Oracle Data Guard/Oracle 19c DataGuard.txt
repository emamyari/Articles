 #--------- Setup  Primary orcldp

SHUT IMMEDIATE;
STARTUP;
SHOW PARAMETER NAME;

ALTER SYSTEM RESET DB_RECOVERY_FILE_DEST SCOPE=SPFILE;

ALTER SYSTEM SET LOG_ARCHIVE_DEST_1=
'LOCATION=/ora/oradata/db11g/arch1/
VALID_FOR=(ALL_LOGFILES,ALL_ROLES)
DB_UNIQUE_NAME=db11g' scope=spfile;

SHUTDOWN IMMEDIATE;
STARTUP MOUNT;
SHOW PARAMETER NAME;

ALTER DATABASE ARCHIVELOG;
ALTER DATABASE OPEN;
ARCHIVE LOG LIST;
ALTER DATABASE FORCE LOGGING;
ALTER SYSTEM SET LOG_ARCHIVE_MAX_PROCESSES=30;
ALTER SYSTEM SET LOCAL_LISTENER='192.168.50.102:1521';

ALTER SYSTEM SET LOG_ARCHIVE_FORMAT='db11g_%t_%s_%r.arc' SCOPE=SPFILE;
ALTER SYSTEM SET DB_RECOVERY_FILE_DEST_SIZE = 10G SCOPE=BOTH;
ALTER SYSTEM SET DB_RECOVERY_FILE_DEST = '/ora/oradata/db11g/fra/'  SCOPE=BOTH;
ALTER SYSTEM SET DB_FLASHBACK_RETENTION_TARGET = 60 SCOPE=BOTH;
ALTER DATABASE FLASHBACK ON;
ALTER SYSTEM SET REMOTE_LOGIN_PASSWORDFILE=EXCLUSIVE SCOPE=SPFILE;
SHUTDOWN IMMEDIATE;
STARTUP MOUNT;
CREATE PFILE FROM SPFILE;
SHUT IMMEDIATE;
STARTUP;

#--------- Setup Standby db11g_stby

ALTER SYSTEM SET DB_UNIQUE_NAME='db11g_stby' SCOPE=SPFILE; 

edit initdb11g_stby.ora - replace db11g with db11g_stby in db unique name and change local listener

Then edit tnsnames.ora and listener.ora (Bottom of this text file)

edit /oracle/network/admin/listener.ora
edit /oracle/network/admin/tnsnames.ora

--Then restart listener
lsnrctl stop   
lsnrctl start  
lsnrctl status 

copy /db2t/V19Database/dbs/initdb11g.ora /db2t/V19Database/dbs/initdb11g_stby.ora

#--------- Setup Standby db11g_stby - Restore

 
SHUT ABORT;
STARTUP NOMOUNT pfile="C:\oracle\database\INITDB11G_stby.ora";
SHOW PARAMETER NAME;

rman TARGET sys/SanaY$123@db11g_stby AUXILIARY sys/SanaY$123@db11g

DUPLICATE TARGET DATABASE
  FOR STANDBY
  FROM ACTIVE DATABASE
  DORECOVER
  SPFILE
    SET db_unique_name='db11g_stby' COMMENT 'IS STANDBY'
    SET db_file_name_convert='/ora/oradata/db11g/','/ora/oradata/db11g/'
    SET log_file_name_convert='/ora/oradata/db11g/','/ora/oradata/db11g/'
    SET CONTROL_FILES='/ora/oradata/db11g/control01.ctl','/ora/oradata/db11g/control02.ctl'
    SET service_names='db11g_stby'
  NOFILENAMECHECK;
 
#--------- Setup Primary db11g - dg_configure_primary_db11g.sql

SHUTDOWN IMMEDIATE;
STARTUP;
ARCHIVE LOG LIST;
SHOW PARAMETER NAME;
SELECT MEMBER FROM V$LOGFILE;
ALTER DATABASE ADD STANDBY LOGFILE THREAD 1 GROUP 4 ('/ora/oradata/db11g/redo04.log') SIZE 200M; 
ALTER DATABASE ADD STANDBY LOGFILE THREAD 1 GROUP 5 ('/ora/oradata/db11g/redo05.log') SIZE 200M; 
ALTER DATABASE ADD STANDBY LOGFILE THREAD 1 GROUP 6 ('/ora/oradata/db11g/redo06.log') SIZE 200M; 
ALTER DATABASE ADD STANDBY LOGFILE THREAD 1 GROUP 7 ('/ora/oradata/db11g/redo07.log') SIZE 200M; 
select thread#, group#, sequence#, status, bytes from v$standby_log;

SELECT MEMBER FROM V$LOGFILE ORDER BY GROUP#;

ALTER SYSTEM SET LOG_ARCHIVE_DEST_1=
'LOCATION=/ora/oradata/db11g/arch1/
VALID_FOR=(ALL_LOGFILES,ALL_ROLES)
DB_UNIQUE_NAME=db11g' scope=spfile;

ALTER SYSTEM SET LOG_ARCHIVE_DEST_2=
'SERVICE=db11g_stby LGWR ASYNC
VALID_FOR=(ALL_LOGFILES,PRIMARY_ROLE)
DB_UNIQUE_NAME=db11g_stby' SCOPE=SPFILE;

ALTER SYSTEM SET LOG_ARCHIVE_CONFIG='DG_CONFIG=(db11g,db11g_stby)';
ALTER SYSTEM SET LOG_ARCHIVE_DEST_STATE_1=ENABLE;
ALTER SYSTEM SET LOG_ARCHIVE_DEST_STATE_2=ENABLE;
ALTER SYSTEM SWITCH LOGFILE;
ALTER SYSTEM ARCHIVE LOG CURRENT;

ALTER SYSTEM SET FAL_CLIENT='db11g';
ALTER SYSTEM SET FAL_SERVER='db11g_stby';
ALTER SYSTEM SET STANDBY_FILE_MANAGEMENT=AUTO;

ALTER DATABASE SET STANDBY DATABASE TO MAXIMIZE PERFORMANCE;
ALTER SYSTEM SET DB_FILE_NAME_CONVERT='/ora/oradata/db11g/','/ora/oradata/db11g/'  SCOPE=SPFILE;
ALTER SYSTEM SET LOG_FILE_NAME_CONVERT='/ora/oradata/db11g/','/ora/oradata/db11g/' SCOPE=SPFILE;

SHUTDOWN IMMEDIATE;
STARTUP;

CREATE PFILE FROM SPFILE;
SHUTDOWN IMMEDIATE;
STARTUP;

ALTER SESSION SET nls_date_format='DD-MON-YYYY HH24:MI:SS';
SELECT SEQUENCE#, FIRST_TIME, NEXT_TIME, APPLIED   FROM V$ARCHIVED_LOG ORDER BY SEQUENCE#;
SELECT DB_UNIQUE_NAME, SWITCHOVER_STATUS, DATABASE_ROLE, OPEN_MODE FROM V$DATABASE;

#--------- Setup Standby  

ALTER DATABASE CREATE STANDBY CONTROLFILE AS '/ora/oradata/db11g/control_standby.ctl';
SHUTDOWN IMMEDIATE;
STARTUP MOUNT;

SHOW PARAMETER NAME;
SELECT MEMBER FROM V$LOGFILE;
ALTER DATABASE ADD STANDBY LOGFILE THREAD 1 GROUP 4 ('/ora/oradata/db11g/redo04.log') SIZE 200M; 
ALTER DATABASE ADD STANDBY LOGFILE THREAD 1 GROUP 5 ('/ora/oradata/db11g/redo05.log') SIZE 200M; 
ALTER DATABASE ADD STANDBY LOGFILE THREAD 1 GROUP 6 ('/ora/oradata/db11g/redo06.log') SIZE 200M; 
ALTER DATABASE ADD STANDBY LOGFILE THREAD 1 GROUP 7 ('/ora/oradata/db11g/redo07.log') SIZE 200M; 
select thread#, group#, sequence#, status, bytes from v$standby_log;
SELECT MEMBER FROM V$LOGFILE ORDER BY GROUP#;

ALTER SYSTEM SET LOG_ARCHIVE_DEST_1=
'LOCATION=/ora/oradata/db11g/arch1/
VALID_FOR=(ALL_LOGFILES,ALL_ROLES)
DB_UNIQUE_NAME=db11g_stby' scope=spfile;

ALTER SYSTEM SET LOG_ARCHIVE_DEST_2=
'SERVICE=db11g LGWR ASYNC
VALID_FOR=(ALL_LOGFILES,PRIMARY_ROLE)
DB_UNIQUE_NAME=db11g' SCOPE=SPFILE;

ALTER SYSTEM SET LOG_ARCHIVE_DEST_STATE_1=ENABLE;
ALTER SYSTEM SET LOG_ARCHIVE_DEST_STATE_2=ENABLE;
ALTER SYSTEM SET LOG_ARCHIVE_MAX_PROCESSES=30;
ALTER SYSTEM SET LOG_ARCHIVE_FORMAT='db11g_%t_%s_%r.arc' SCOPE=SPFILE;
ALTER SYSTEM SET REMOTE_LOGIN_PASSWORDFILE=EXCLUSIVE SCOPE=SPFILE;

ALTER SYSTEM SET LOG_ARCHIVE_CONFIG='DG_CONFIG=(db11g_stby,db11g)';
ALTER SYSTEM SET FAL_CLIENT='db11g_stby';
ALTER SYSTEM SET FAL_SERVER='db11g';
ALTER SYSTEM SET SERVICE_NAMES='db11g_stby';
ALTER SYSTEM SET LOCAL_LISTENER='192.168.50.103:1521';

ALTER SYSTEM SET STANDBY_FILE_MANAGEMENT=AUTO;
ALTER DATABASE SET STANDBY DATABASE TO MAXIMIZE PERFORMANCE;

SHUTDOWN IMMEDIATE;
STARTUP MOUNT;

ALTER SYSTEM SET DB_RECOVERY_FILE_DEST_SIZE = 10G SCOPE=BOTH;
ALTER SYSTEM SET DB_RECOVERY_FILE_DEST = '/ora/oradata/db11g/fra/'  SCOPE=BOTH;
ALTER SYSTEM SET DB_FLASHBACK_RETENTION_TARGET = 60 SCOPE=BOTH;
ALTER DATABASE FLASHBACK ON;
CREATE PFILE FROM SPFILE;
SHUTDOWN IMMEDIATE;
STARTUP;

ALTER DATABASE RECOVER MANAGED STANDBY DATABASE USING CURRENT LOGFILE DISCONNECT FROM SESSION;

ALTER SESSION SET nls_date_format='DD-MON-YYYY HH24:MI:SS';
SELECT SEQUENCE#, FIRST_TIME, NEXT_TIME, APPLIED   FROM V$ARCHIVED_LOG ORDER BY SEQUENCE#;
SELECT DB_UNIQUE_NAME, SWITCHOVER_STATUS, DATABASE_ROLE, OPEN_MODE FROM V$DATABASE;

#--------- Testing

DROP TABLE TEST1;
CREATE TABLE TEST1 (C1 INT PRIMARY KEY, C2 CHAR(6));
DELETE FROM TEST1;

INSERT INTO TEST1 VALUES (456789, 'rap');
INSERT INTO TEST1 VALUES (222, 'cap');
COMMIT;
ALTER SYSTEM CHECKPOINT;
ALTER SYSTEM SWITCH LOGFILE;
ALTER SYSTEM archIVE LOG CURRENT;
SELECT * FROM TEST1;

DELETE FROM TEST1;

INSERT INTO TEST1 VALUES (53, 'rap');
INSERT INTO TEST1 VALUES (456456, 'cap');
COMMIT;
ALTER SYSTEM CHECKPOINT;
ALTER SYSTEM SWITCH LOGFILE;
ALTER SYSTEM ARCHIVE LOG CURRENT;
SELECT * FROM TEST1;
INSERT INTO TEST1 VALUES (61, 'King');
INSERT INTO TEST1 VALUES (65, 'Queen');
COMMIT;
SELECT * FROM TEST1;
INSERT INTO TEST1 VALUES (75, 'Rock');
INSERT INTO TEST1 VALUES (78, 'Pop');
COMMIT;
ALTER SYSTEM CHECKPOINT;
ALTER SYSTEM SWITCH LOGFILE;
ALTER SYSTEM ARCHIVE LOG CURRENT;
SELECT * FROM TEST1;

#--------- Configure DataGuard Broker

-- Set below on PRIMARY AND STANDBY
alter system set DG_BROKER_START=TRUE SCOPE=BOTH;

dgmgrl sys/SanaY$123 as sysdba

DGMGRL> create configuration 'db11g' as primary database is 'db11g' connect identifier is db11g;

DGMGRL> add database 'db11g_stby' as connect identifier is 'db11g_stby' maintained as physical;
Error: ORA-16698: LOG_ARCHIVE_DEST_n parameter set for object to be added
--- To resolve this error set below
--- No need to start the database post this setting
alter system set LOG_ARCHIVE_DEST_2='';

DGMGRL> add database 'db11g_stby' as connect identifier is 'db11g_stby' maintained as physical;
DGMGRL> show configuration;
DGMGRL> edit database db11g set property staticconnectidentifier='(DESCRIPTION=(ADDRESS=(PROTOCOL=TCP)(PORT=1521)(HOST=192.168.50.102))(CONNECT_DATA=(SERVICE_NAME=db11g)(INSTANCE_NAME=db11g)(SERVER=DEDICATED)))';
DGMGRL> edit database db11g_stby set property staticconnectidentifier='(DESCRIPTION=(ADDRESS=(PROTOCOL=TCP)(PORT=1521)(HOST=192.168.50.103))(CONNECT_DATA=(SERVICE_NAME=db11g_stby)(INSTANCE_NAME=db11g)(SERVER=DEDICATED)))';
DGMGRL> enable configuration;
DGMGRL> show configuration;
DGMGRL> switchover to 'db11g_stby';

dgmgrl sys/password as sysdba
SELECT DB_UNIQUE_NAME, DATABASE_ROLE, SWITCHOVER_STATUS  FROM V$DATABASE;

DGMGRL> enable fast_start failover;
DGMGRL> show configuration;
DGMGRL> disable fast_start failover;
DGMGRL> disable configuration;
DGMGRL> edit database db11g set property 'LogXptMode'='sync';
DGMGRL> edit database db11g_stby set property 'LogXptMode'='sync';
DGMGRL> edit configuration set protection mode as maxavailability;
DGMGRL> enable  configuration;
DGMGRL> enable fast_start failover;
DGMGRL> show configuration;
DGMGRL> show fast_start failover;

 

#--------- Reference File1
 
 
 
 # listener.ora Network Configuration File: C:\oracle\NETWORK\ADMIN\listener.ora
# Generated by Oracle configuration tools.


LISTENER =
  (DESCRIPTION_LIST =
    (DESCRIPTION =
      (ADDRESS = (PROTOCOL = TCP)(HOST = 192.168.50.102)(PORT = 1521))
      (ADDRESS = (PROTOCOL = IPC)(KEY = EXTPROC1521))
    )
  )

SID_LIST_LISTENER =
  (SID_LIST =
    (SID_DESC =
      (GLOBAL_DBNAME = db11g_DGMGRL)
      (ORACLE_HOME = C:\oracle)
      (SID_NAME = db11g)
      (ENVS="TNS_ADMIN=C:\oracle\network\admin")
    )
  )

ADR_BASE_LISTENER = C:\ora

 
#--------- Reference File2

# tnsnames.ora Network Configuration File: C:\oracle\NETWORK\ADMIN\tnsnames.ora
# Generated by Oracle configuration tools.

db11g =
  (DESCRIPTION =
    (ADDRESS_LIST =
      (ADDRESS = (PROTOCOL = TCP)(HOST = 192.168.50.102)(PORT = 1521))
    )
    (CONNECT_DATA =
      (SID = db11g)
    )
  )

db11g_stby =
  (DESCRIPTION =
    (ADDRESS_LIST =
      (ADDRESS = (PROTOCOL = TCP)(HOST = 192.168.50.103)(PORT = 1521))
    )
    (CONNECT_DATA =
      (SID = db11g)
    )
  )


#--------- Reference File3


# listener.ora Network Configuration File: C:\oracle\NETWORK\ADMIN\listener.ora
# Generated by Oracle configuration tools.

LISTENER =
  (DESCRIPTION_LIST =
    (DESCRIPTION =
      (ADDRESS = (PROTOCOL = TCP)(HOST = 192.168.50.103)(PORT = 1521))
      (ADDRESS = (PROTOCOL = IPC)(KEY = EXTPROC1521))
    )
  )

SID_LIST_LISTENER =
  (SID_LIST =
    (SID_DESC =
      (GLOBAL_DBNAME = db11g_stby_DGMGRL)
      (ORACLE_HOME = C:\oracle)
      (SID_NAME = db11g)
      (ENVS="TNS_ADMIN=C:\oracle\network\admin")
    )
  )

ADR_BASE_LISTENER = C:\ora

#--------- Reference File4

# tnsnames.ora Network Configuration File: C:\oracle\NETWORK\ADMIN\tnsnames.ora
# Generated by Oracle configuration tools.

db11g =
  (DESCRIPTION =
    (ADDRESS_LIST =
      (ADDRESS = (PROTOCOL = TCP)(HOST = 192.168.50.102)(PORT = 1521))
    )
    (CONNECT_DATA =
      (SID = db11g)
    )
  )

db11g_stby =
  (DESCRIPTION =
    (ADDRESS_LIST =
      (ADDRESS = (PROTOCOL = TCP)(HOST = 192.168.50.103)(PORT = 1521))
    )
    (CONNECT_DATA =
      (SID = db11g)
    )
  )




